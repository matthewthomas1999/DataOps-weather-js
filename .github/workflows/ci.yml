name: Weather Pipeline CI/CD

on: 
    push:
    schedule:
        - cron: "0 */2 * * *" #update every 2 hours
    workflow_dispatch:

permissions:
    contents: write

jobs: 
    test_and_fetch: 
        runs-on: ubuntu-latest
        steps: 
          - name: Checkout our repo
            uses: actions/checkout@v4

          - name: Use Node.js
            uses: actions/setup-node@v4
            with:
                node-version: "22"

          - name: Cache Node modules
            uses: actions/cache@v4
            with:
                path: ~/.npm
                key: ${{runner.os}}-node-${{ hashFiles('package-lock.json') }}  
                
          - name: Install dependencies
            run: npm ci

          - name: fetch latest weather  
            env:
                WEATHER_API_KEY: ${{secrets.WEATHER_API_KEY}}
                WEATHER_CITY: ${{secrets.CITY}}
            run: node fetchWeather.js

          - name: commit weather data if changed
            run:
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git add data/weather.json data/weather_log.csv || true
                git commit -m "ci: update weather data" || echo "NO changes to commit"
                git push || echo "push failed or no changes"

          - name: trigger render deploy
            run: curl -X POST ${{secrets.RENDER_DEPLOY_HOOK}}
                 